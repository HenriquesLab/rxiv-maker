name: Docker Build & Release

on:
  push:
    branches: [main, dev]
    paths:
      - 'src/docker/images/base/Dockerfile'
      - 'pyproject.toml'
      - 'src/docker/images/base/build.sh'
      - 'src/docker/images/base/Makefile'
      - '.github/workflows/docker-build.yml'

  pull_request:
    branches: [main, dev]
    paths:
      - 'src/docker/images/base/Dockerfile'
      - 'pyproject.toml'
      - 'src/docker/images/base/build.sh'
      - 'src/docker/images/base/Makefile'
      - '.github/workflows/docker-build.yml'

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build for'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
      push_to_registry:
        description: 'Push to Docker Hub'
        required: false
        default: false
        type: boolean
      test_only:
        description: 'Build and test only (no push)'
        required: false
        default: false
        type: boolean

# Minimal permissions
permissions:
  contents: read
  packages: write  # For Docker registry if needed

# Cancel previous runs on same PR
concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  DOCKER_BUILDKIT: 1
  REGISTRY: docker.io
  IMAGE_NAME: henriqueslab/rxiv-maker-base

jobs:
  # Detect changes and set build strategy
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      dockerfile-changed: ${{ steps.changes.outputs.dockerfile }}
      dependencies-changed: ${{ steps.changes.outputs.dependencies }}
      build-scripts-changed: ${{ steps.changes.outputs.build-scripts }}
      should-build: ${{ steps.decision.outputs.should-build }}
      dependency-hash: ${{ steps.hash.outputs.dependency-hash }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for comparison

      - name: Detect file changes
        id: changes
        run: |
          echo "Checking for relevant file changes..."

          # Handle initial commit case where HEAD~1 doesn't exist
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            # Normal case: compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # Initial commit case: show all files in current commit
            echo "âš ï¸ Initial commit detected, checking all files in current commit"
            CHANGED_FILES=$(git show --name-only --pretty=format: HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check for Dockerfile changes
          if echo "$CHANGED_FILES" | grep -E '^src/docker/images/base/Dockerfile$'; then
            echo "dockerfile=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Dockerfile changed"
          else
            echo "dockerfile=false" >> $GITHUB_OUTPUT
          fi

          # Check for dependency changes
          if echo "$CHANGED_FILES" | grep -E '^pyproject.toml$'; then
            echo "dependencies=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Dependencies changed"
          else
            echo "dependencies=false" >> $GITHUB_OUTPUT
          fi

          # Check for build script changes
          if echo "$CHANGED_FILES" | grep -E '^src/docker/images/base/(build\.sh|Makefile)$'; then
            echo "build-scripts=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Build scripts changed"
          else
            echo "build-scripts=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate dependency hash
        id: hash
        run: |
          # Create hash of Python dependencies for cache key
          python3 << 'EOF'
          import hashlib
          import os
          import re

          with open('pyproject.toml', 'r') as f:
              content = f.read()

          # Extract dependencies section
          deps_match = re.search(r'dependencies\s*=\s*\[(.*?)\]', content, re.DOTALL)
          if deps_match:
              deps_content = deps_match.group(1)
              # Create hash of dependency content
              dep_hash = hashlib.sha256(deps_content.encode()).hexdigest()[:16]
              print(f"dependency-hash={dep_hash}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"dependency-hash={dep_hash}\n")
          else:
              print("dependency-hash=unknown")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("dependency-hash=unknown\n")
          EOF

      - name: Build decision
        id: decision
        run: |
          # Determine if we should build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Manual trigger - will build"
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Release trigger - will build"
          elif [ "${{ steps.changes.outputs.dockerfile }}" == "true" ] || \
               [ "${{ steps.changes.outputs.dependencies }}" == "true" ] || \
               [ "${{ steps.changes.outputs.build-scripts }}" == "true" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Relevant changes detected - will build"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No relevant changes - skipping build"
          fi

  # Build and test Docker image
  build-and-test:
    name: Build & Test Docker Image
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-build == 'true'
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64, linux/arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set platform slug
        id: platform
        run: |
          # Convert platform name to safe filename (e.g., linux/amd64 -> linux-amd64)
          PLATFORM_SLUG=$(echo "${{ matrix.platform }}" | sed 's/\//-/g')
          echo "slug=$PLATFORM_SLUG" >> $GITHUB_OUTPUT
          echo "Platform: ${{ matrix.platform }} -> Slug: $PLATFORM_SLUG"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.platform }}
          # ðŸš€ PHASE 4: Enhanced Buildx configuration for maximum performance
          driver-opts: |
            network=host
            image=moby/buildkit:v0.12.4
          config-inline: |
            [worker.oci]
              max-parallelism = 8
            [worker.containerd]
              max-parallelism = 8
            [registry."docker.io"]
              mirrors = ["mirror.gcr.io"]
            # Enable experimental features for multi-stage parallel builds
            [feature-gates]
              "multi-platform" = true
              "cache-backend" = true

      - name: Validate build environment
        run: |
          echo "ðŸ” Validating build environment..."

          # Check Docker buildx
          if ! docker buildx version >/dev/null 2>&1; then
            echo "âŒ Docker buildx not available"
            exit 1
          fi
          echo "âœ… Docker buildx: $(docker buildx version)"

          # Check Dockerfile exists
          if [ ! -f "src/docker/images/base/Dockerfile" ]; then
            echo "âŒ Dockerfile not found at src/docker/images/base/Dockerfile"
            exit 1
          fi
          echo "âœ… Dockerfile found"

          # Check pyproject.toml exists (for dependency validation)
          if [ ! -f "pyproject.toml" ]; then
            echo "âŒ pyproject.toml not found"
            exit 1
          fi
          echo "âœ… pyproject.toml found"

          echo "âœ… Build environment validation complete"

      - name: Validate Docker Hub credentials
        id: check-creds
        if: github.event_name != 'pull_request'
        run: |
          # Only attempt login if we're on main branch or manual trigger with push enabled
          SHOULD_LOGIN=false

          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ðŸ”‘ Main branch detected - credentials required for push"
            SHOULD_LOGIN=true
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "ðŸ”‘ Release event - credentials required for push"
            SHOULD_LOGIN=true
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.push_to_registry }}" == "true" ]; then
            echo "ðŸ”‘ Manual trigger with push enabled - credentials required"
            SHOULD_LOGIN=true
          else
            echo "ðŸ”“ Dev branch or test-only mode - skipping Docker Hub authentication"
            SHOULD_LOGIN=false
          fi

          echo "should-login=$SHOULD_LOGIN" >> $GITHUB_OUTPUT

          if [ "$SHOULD_LOGIN" == "true" ]; then
            if [ -z "${{ secrets.DOCKER_USERNAME }}" ] || [ -z "${{ secrets.DOCKER_PUSH }}" ]; then
              echo "âŒ Docker Hub credentials not available"
              echo "This build will proceed without registry push capability"
              echo "should-login=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Docker Hub credentials available"
            fi
          fi

      - name: Log in to Docker Hub
        if: steps.check-creds.outputs.should-login == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PUSH }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Rxiv-Maker Base
            org.opencontainers.image.description=Base Docker image for rxiv-maker with LaTeX, Python, R, and system dependencies
            org.opencontainers.image.vendor=Rxiv-Maker Project
            org.opencontainers.image.dependency-hash=${{ needs.detect-changes.outputs.dependency-hash }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/docker/images/base/Dockerfile
          platforms: ${{ matrix.platform }}
          push: false  # Don't push yet, test first
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ðŸš€ PHASE 4: Enhanced BuildKit caching with multiple cache sources
          cache-from: |
            type=gha,scope=build-${{ matrix.platform }}
            type=gha,scope=build-shared
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-${{ matrix.platform }}
          cache-to: |
            type=gha,scope=build-${{ matrix.platform }},mode=max
            type=gha,scope=build-shared,mode=max
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-${{ matrix.platform }},mode=max
          # ðŸš€ PHASE 4: Enhanced build arguments for maximum acceleration
          build-args: |
            USE_EATMYDATA=true
            BUILDKIT_INLINE_CACHE=1
          # ðŸš€ PHASE 4: Enable all BuildKit features for multi-stage optimization
          outputs: type=docker,dest=/tmp/image-${{ steps.platform.outputs.slug }}.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ steps.platform.outputs.slug }}
          path: /tmp/image-${{ steps.platform.outputs.slug }}.tar
          retention-days: 1

  # Test the built images
  test-images:
    name: Test Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: needs.detect-changes.outputs.should-build == 'true'
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        test-type: [base-deps, runtime-injection, full-workflow]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: docker-image-*
          merge-multiple: true

      - name: Load Docker images
        run: |
          # Load all built images
          for image in docker-image-*/image-*.tar; do
            if [ -f "$image" ]; then
              echo "Loading $image..."
              docker load --input "$image"
            fi
          done

          # List loaded images
          docker images | grep henriqueslab/rxiv-maker-base || echo "No images found"

          # Ensure a :latest tag exists for tests irrespective of metadata-action tags
          # Tag the most recently built image as :latest if not present
          if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q '^henriqueslab/rxiv-maker-base:latest$'; then
            most_recent=$(docker images --format '{{.Repository}}:{{.Tag}} {{.CreatedAt}}' | awk '/^henriqueslab\/rxiv-maker-base:/ {print $1"|"$2" "$3" "$4" "$5" "$6}' | sort -rk2 | head -n1 | cut -d'|' -f1)
            if [ -n "$most_recent" ]; then
              echo "Tagging $most_recent as henriqueslab/rxiv-maker-base:latest for tests"
              docker tag "$most_recent" henriqueslab/rxiv-maker-base:latest
            fi
          fi

      - name: Test base dependencies
        if: matrix.test-type == 'base-deps'
        run: |
          echo "ðŸ§ª Testing base dependencies in built image..."
          docker run --rm henriqueslab/rxiv-maker-base:latest python3 -c "
          import sys
          print(f'Python version: {sys.version}')

          # Test essential dependencies that were missing before
          essential_deps = ['platformdirs', 'click', 'rich', 'packaging', 'tomli_w', 'typing_extensions']
          for dep in essential_deps:
              try:
                  __import__(dep)
                  print(f'âœ… {dep}')
              except ImportError as e:
                  print(f'âŒ {dep}: {e}')
                  exit(1)

          print('âœ… All base dependencies available!')
          "

      - name: Test runtime dependency injection
        if: matrix.test-type == 'runtime-injection'
        run: |
          echo "ðŸ§ª Testing runtime dependency injection..."
          docker run --rm -v $PWD:/workspace henriqueslab/rxiv-maker-base:latest bash -c "
          echo 'Testing runtime dependency injection scripts...'

          # Test install-project-deps.sh exists and is executable
          if [ -x /usr/local/bin/install-project-deps.sh ]; then
              echo 'âœ… install-project-deps.sh is executable'
          else
              echo 'âŒ install-project-deps.sh not found or not executable'
              exit 1
          fi

          # Test dev-mode.sh exists and is executable
          if [ -x /usr/local/bin/dev-mode.sh ]; then
              echo 'âœ… dev-mode.sh is executable'
          else
              echo 'âŒ dev-mode.sh not found or not executable'
              exit 1
          fi

          # Test dependency installation
          /usr/local/bin/install-project-deps.sh

          # Test critical imports after installation
          python3 -c '
          import sys
          sys.path.insert(0, \"/workspace/src\")
          try:
              from rxiv_maker.utils.cache_utils import get_cache_dir
              from rxiv_maker.validators.doi_validator import DOIValidator
              print(\"âœ… Runtime dependency injection successful!\")
          except ImportError as e:
              print(f\"âŒ Import error after injection: {e}\")
              exit(1)
          '
          "

      - name: Test full workflow
        if: matrix.test-type == 'full-workflow'
        run: |
          echo "ðŸ§ª Testing full Docker workflow..."

          # Test usage script
          docker run --rm henriqueslab/rxiv-maker-base:latest usage.sh

          # Test verification script
          docker run --rm henriqueslab/rxiv-maker-base:latest verify-python-deps.sh

          # Test with mounted project
          docker run --rm -v $PWD:/workspace henriqueslab/rxiv-maker-base:latest python3 /workspace/validate-container-imports.py

      - name: Test summary
        run: |
          echo "## Docker Image Test Results (${{ matrix.test-type }})" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Test completed successfully" >> $GITHUB_STEP_SUMMARY

  # Push to Docker Hub (only on main branch or releases)
  push-to-registry:
    name: Push to Docker Hub
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test, test-images]
    if: |
      needs.detect-changes.outputs.should-build == 'true' &&
      (
        github.ref == 'refs/heads/main' ||
        github.event_name == 'release' ||
        (github.event_name == 'workflow_dispatch' && inputs.push_to_registry == true)
      ) &&
      inputs.test_only != 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Validate Docker Hub credentials
        if: |
          github.ref == 'refs/heads/main' ||
          github.event_name == 'release' ||
          (github.event_name == 'workflow_dispatch' && inputs.push_to_registry == true)
        run: |
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "âŒ DOCKER_USERNAME secret not set"
            echo "Please configure Docker Hub credentials in repository secrets"
            exit 1
          fi

          if [ -z "${{ secrets.DOCKER_PUSH }}" ]; then
            echo "âŒ DOCKER_PUSH secret not set"
            echo "Please configure Docker Hub credentials in repository secrets"
            exit 1
          fi

          echo "âœ… Docker Hub credentials configured"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PUSH }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Rxiv-Maker Base
            org.opencontainers.image.description=Base Docker image for rxiv-maker with runtime dependency injection
            org.opencontainers.image.vendor=Rxiv-Maker Project
            org.opencontainers.image.dependency-hash=${{ needs.detect-changes.outputs.dependency-hash }}

      - name: Build and push multi-platform image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/docker/images/base/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ðŸš€ PHASE 4: Multi-platform enhanced caching strategy
          cache-from: |
            type=gha,scope=build-linux-amd64
            type=gha,scope=build-linux-arm64
            type=gha,scope=build-shared
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-linux-amd64
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-linux-arm64
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-shared
          cache-to: |
            type=gha,scope=build-shared,mode=max
            type=registry,ref=${{ env.IMAGE_NAME }}:buildcache-shared,mode=max
          # ðŸš€ PHASE 4: Production build arguments
          build-args: |
            USE_EATMYDATA=true
            BUILDKIT_INLINE_CACHE=1
          # ðŸš€ PHASE 4: Enable attestations for enhanced security and traceability
          provenance: true
          sbom: true

      - name: Create release summary
        run: |
          echo "## ðŸ³ Docker Image Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "**Dependency Hash:** ${{ needs.detect-changes.outputs.dependency-hash }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Usage:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Development mode with runtime dependency injection" >> $GITHUB_STEP_SUMMARY
          echo "docker run -it --rm -v \$PWD:/workspace ${{ env.IMAGE_NAME }}:latest dev-mode.sh" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Phase 4: Cache Management and Optimization
  cache-management:
    name: Cache Management (Phase 4)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: needs.detect-changes.outputs.should-build == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache size analysis
        run: |
          echo "## ðŸš€ PHASE 4: Build Cache Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Analyze GitHub Actions cache usage
          echo "**GitHub Actions Cache Usage:**" >> $GITHUB_STEP_SUMMARY
          gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '
            .actions_caches[] |
            select(.key | contains("buildkit")) |
            "| \(.key) | \(.size_in_bytes / 1024 / 1024 | round)MB | \(.created_at[:10]) |"
          ' | head -20 >> $GITHUB_STEP_SUMMARY || echo "No buildkit caches found" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cache Optimization Status:**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Multi-source caching (GHA + Registry)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Platform-specific cache scopes" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Enhanced BuildKit configuration" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Parallel multi-stage builds" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prune old caches
        continue-on-error: true
        run: |
          echo "ðŸ§¹ Pruning old Docker build caches..."

          # Clean up old GitHub Actions caches (keep last 10 per scope)
          gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '
            .actions_caches[] |
            select(.key | contains("buildkit")) |
            select(.created_at < (now - 604800 | strftime("%Y-%m-%dT%H:%M:%SZ"))) |
            .id
          ' | head -20 | while read cache_id; do
            if [ -n "$cache_id" ]; then
              echo "Deleting cache ID: $cache_id"
              gh api -X DELETE repos/${{ github.repository }}/actions/caches/$cache_id || true
            fi
          done

          echo "âœ… Cache cleanup completed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test, test-images, push-to-registry, cache-management]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Build summary
        run: |
          echo "## Docker Build & Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.should-build }}" == "true" ]; then
            echo "**Build Triggered:** âœ… Yes" >> $GITHUB_STEP_SUMMARY
            echo "**Dockerfile Changed:** ${{ needs.detect-changes.outputs.dockerfile-changed }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dependencies Changed:** ${{ needs.detect-changes.outputs.dependencies-changed }}" >> $GITHUB_STEP_SUMMARY
            echo "**Build Scripts Changed:** ${{ needs.detect-changes.outputs.build-scripts-changed }}" >> $GITHUB_STEP_SUMMARY
            echo "**Dependency Hash:** ${{ needs.detect-changes.outputs.dependency-hash }}" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.build-and-test.result }}" == "success" ]; then
              echo "**Build Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Build Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.test-images.result }}" == "success" ]; then
              echo "**Tests Status:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Tests Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.push-to-registry.result }}" == "success" ]; then
              echo "**Registry Push:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.push-to-registry.result }}" == "skipped" ]; then
              echo "**Registry Push:** â­ï¸ Skipped (PR or test-only)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Registry Push:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.cache-management.result }}" == "success" ]; then
              echo "**Phase 4 Cache Management:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.cache-management.result }}" == "skipped" ]; then
              echo "**Phase 4 Cache Management:** â­ï¸ Skipped (not main branch)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Phase 4 Cache Management:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Phase 4 CI/CD Optimizations Active:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Multi-source BuildKit caching (GHA + Registry)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Platform-specific cache scopes" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Enhanced Buildx configuration (8x parallelism)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Automatic cache cleanup and management" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… eatmydata filesystem acceleration" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Multi-stage parallel builds with enhanced layer ordering" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Build Triggered:** â­ï¸ No (no relevant changes)" >> $GITHUB_STEP_SUMMARY
          fi
