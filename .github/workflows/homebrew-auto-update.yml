name: Auto-update Homebrew Formula

on:
  release:
    types: [published]

permissions:
  contents: read

env:
  HOMEBREW_TAP_REPO: HenriquesLab/homebrew-rxiv-maker
  FORMULA_FILE: Formula/rxiv-maker.rb

jobs:
  update-homebrew-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get release information
        id: release
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Get release tarball URL
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz"
          echo "tarball_url=$TARBALL_URL" >> $GITHUB_OUTPUT

          echo "üì¶ Release version: $VERSION"
          echo "üîó Tarball URL: $TARBALL_URL"

      - name: Download and calculate SHA256
        id: sha256
        run: |
          # Download the release tarball
          echo "‚¨áÔ∏è Downloading release tarball..."
          curl -L -o rxiv-maker-${{ steps.release.outputs.version }}.tar.gz \
            "${{ steps.release.outputs.tarball_url }}"

          # Calculate SHA256 hash
          SHA256=$(sha256sum rxiv-maker-${{ steps.release.outputs.version }}.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

          echo "üîí SHA256: $SHA256"

          # Verify download
          ls -la rxiv-maker-${{ steps.release.outputs.version }}.tar.gz

      - name: Checkout Homebrew tap repository
        uses: actions/checkout@v5
        with:
          repository: ${{ env.HOMEBREW_TAP_REPO }}
          path: homebrew-tap
          token: ${{ secrets.HOMEBREW_UPDATE_TOKEN }}

      - name: Update formula
        working-directory: homebrew-tap
        run: |
          # Create new branch for the update with timestamp to avoid conflicts
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="auto-update-v${{ steps.release.outputs.version }}-${TIMESTAMP}"

          echo "üåø Creating branch: $BRANCH_NAME"

          # Check if a similar branch exists and clean up old ones
          echo "üßπ Cleaning up old auto-update branches..."
          git branch -r | grep "origin/auto-update-v${{ steps.release.outputs.version }}" | head -5 | while read -r branch; do
            branch_name=$(echo "$branch" | sed 's|origin/||')
            if [ "$branch_name" != "$BRANCH_NAME" ]; then
              echo "üóëÔ∏è Deleting old branch: $branch_name"
              git push origin --delete "$branch_name" || echo "‚ö†Ô∏è Could not delete $branch_name (may not exist)"
            fi
          done

          # Create new branch
          git checkout -b "$BRANCH_NAME"

          # Update the formula file
          echo "üìù Updating formula with new version and SHA256..."

          # Use sed to update any URL pattern to the new GitHub release URL
          sed -i 's|url ".*"|url "${{ steps.release.outputs.tarball_url }}"|g' ${{ env.FORMULA_FILE }}
          sed -i 's|sha256 ".*"|sha256 "${{ steps.sha256.outputs.sha256 }}"|g' ${{ env.FORMULA_FILE }}

          # Show the changes
          echo "üìã Formula changes:"
          git diff ${{ env.FORMULA_FILE }}

      - name: Commit and create pull request
        working-directory: homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_UPDATE_TOKEN }}
        run: |
          # Get the branch name with timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="auto-update-v${{ steps.release.outputs.version }}-${TIMESTAMP}"

          # Configure git
          git config user.name "rxiv-maker-bot"
          git config user.email "noreply@henriqueslab.org"

          # Commit changes
          git add ${{ env.FORMULA_FILE }}
          git commit -m "chore: update rxiv-maker to v${{ steps.release.outputs.version }}

          Auto-generated update from rxiv-maker release v${{ steps.release.outputs.version }}

          - Updated URL to new release tarball
          - Updated SHA256 hash: ${{ steps.sha256.outputs.sha256 }}

          ü§ñ Generated by GitHub Actions from ${{ github.repository }}"

          # Push branch with retry logic
          echo "üì§ Pushing branch: $BRANCH_NAME"

          PUSH_SUCCESS=false
          for attempt in {1..3}; do
            echo "üîÑ Push attempt $attempt/3..."

            if git push origin "$BRANCH_NAME"; then
              echo "‚úÖ Successfully pushed branch on attempt $attempt"
              PUSH_SUCCESS=true
              break
            else
              echo "‚ùå Push failed on attempt $attempt"

              if [ $attempt -lt 3 ]; then
                echo "‚è≥ Waiting 10 seconds before retry..."
                sleep 10

                # Try to fetch latest changes and rebase if needed
                echo "üîÑ Fetching latest changes..."
                git fetch origin main

                # Generate new unique branch name for retry
                RETRY_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                NEW_BRANCH_NAME="auto-update-v${{ steps.release.outputs.version }}-${RETRY_TIMESTAMP}"
                echo "üåø Trying with new branch name: $NEW_BRANCH_NAME"

                git checkout -b "$NEW_BRANCH_NAME"
                BRANCH_NAME="$NEW_BRANCH_NAME"
              fi
            fi
          done

          if [ "$PUSH_SUCCESS" != "true" ]; then
            echo "‚ùå Failed to push after 3 attempts"
            echo "üîç Checking remote branches..."
            git branch -r | grep "auto-update" || echo "No auto-update branches found"
            echo "üìä Repository status:"
            git status
            exit 1
          fi

          # Create pull request using GitHub CLI
          echo "üìã Creating pull request..."

          # Check if PR already exists for this version
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "üìù Pull request already exists: #$EXISTING_PR"
            echo "üîó PR URL: $(gh pr view $EXISTING_PR --json url --jq '.url')"
          else
            gh pr create \
              --title "üöÄ Auto-update rxiv-maker to v${{ steps.release.outputs.version }}" \
              --body "$(cat <<'EOF'
          ## üì¶ Automatic Formula Update

          This PR automatically updates the rxiv-maker Homebrew formula to version **v${{ steps.release.outputs.version }}**.

          ### üîÑ Changes Made
          - ‚úÖ Updated release URL to: `${{ steps.release.outputs.tarball_url }}`
          - ‚úÖ Updated SHA256 hash to: `${{ steps.sha256.outputs.sha256 }}`

          ### üß™ Testing
          After merging, the formula can be tested with:
          ```bash
          brew tap HenriquesLab/rxiv-maker
          brew install rxiv-maker
          rxiv --version
          ```

          ### ü§ñ Automation
          This PR was automatically generated by the [rxiv-maker repository](https://github.com/${{ github.repository }}) GitHub Actions workflow.

          **Release**: ${{ github.event.release.html_url }}
          **Workflow**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          )" \
              --head "$BRANCH_NAME" \
              --base main

            echo "‚úÖ Pull request created successfully"
          fi

      - name: Summary
        run: |
          echo "## üéâ Homebrew Formula Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Successfully updated Homebrew formula for rxiv-maker v${{ steps.release.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tarball URL**: ${{ steps.release.outputs.tarball_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: \`${{ steps.sha256.outputs.sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Homebrew Repository**: [${{ env.HOMEBREW_TAP_REPO }}](https://github.com/${{ env.HOMEBREW_TAP_REPO }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Next Steps**: Review and merge the auto-generated pull request in the Homebrew tap repository." >> $GITHUB_STEP_SUMMARY
